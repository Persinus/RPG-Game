{
  _id: ObjectId("..."),
  username: "manh72",
  password_hash: "sha256:xxxxxx",
  email: "manh@example.com",
  created_at: ISODate("2025-09-22T00:00:00Z"),
  last_login: ISODate("2025-10-10T12:00:00Z"),

  // âš”ï¸ ThÃ´ng tin nhÃ¢n váº­t
  character: {
    name: "Máº¡nh",
    class: "Warrior",          // tÃ¹y thÃªm náº¿u cáº§n
    level: 12,                 // cáº¥p hiá»‡n táº¡i
    exp: 3400,                 // exp hiá»‡n cÃ³ (tá»•ng)
    exp_present:1200,
    
    // Chá»‰ sá»‘ cÆ¡ báº£n (base stats, chÆ°a cá»™ng bonus tá»« trang bá»‹/pet)
    hp: 180,
    mp: 100,
    max_hp: 180,
    max_mp: 100,
    damage: 45,
    skill_damage_percent: 0.20,

    // ğŸ’° TÃ i sáº£n trong game
    gold: 5000,
    diamond: 25,

    // ğŸ“ Vá»‹ trÃ­ hiá»‡n táº¡i
    position: {
      map_id: "forest_zone_1",
    },

    // ğŸ¾ Pet (lÆ°u tÃªn + bonus Ä‘á»ƒ dá»… cá»™ng khi load)
    pet: {
      name: "Flame Pup",
      // bonus cÃ³ thá»ƒ lÃ  0 náº¿u pet khÃ´ng tÄƒng loáº¡i nÃ y
      bonus_hp: 20,         // tÄƒng trá»±c tiáº¿p max_hp hoáº·c hp tuá»³ báº¡n Ã¡p dá»¥ng
      bonus_mp: 0,          // tÄƒng mp
      bonus_damage: 5       // tÄƒng damage
    },

    // ğŸ¯ Nhiá»‡m vá»¥
    // currentQuest: nhiá»‡m vá»¥ Ä‘ang lÃ m (null náº¿u khÃ´ng cÃ³)
    // quests_completed: array id nhiá»‡m vá»¥ Ä‘Ã£ hoÃ n thÃ nh
    // quest_log: list nhiá»‡m vá»¥ Ä‘ang cÃ³ tiáº¿n Ä‘á»™ (cÃ³ thá»ƒ chá»©a partial progress)
    currentQuest: {
      quest_id: "quest_005",
      name: "Clear the Slimes",
      type: "kill",
      target: { monster: "slime", count: 10 },
      progress: { current: 4, required: 10 }, // Ä‘ang lÃ m Ä‘Æ°á»£c 4/10
      reward: { gold: 200, exp: 150, item: "hp_potion" },
    
    },

    quests_completed: [
      "quest_001",
      "quest_002"
    ],

    quest_log: [
      // cÃ³ thá»ƒ lÆ°u nhiá»u nhiá»‡m vá»¥ Ä‘ang lÃ m (main + side)
      {
        quest_id: "quest_005",
        progress: { current: 4, required: 10 },
      }
    ]
  },

  // ğŸ§¥ Trang bá»‹ hiá»‡n táº¡i
  equipment: {
    weapon: { id: "weapon_iron_01", name: "Iron Sword", level: 2, bonus_damage: 10 },
    armor: { id: "armor_leather_01", name: "Leather Armor", level: 1, skill_boost: 0.05 },
    pants: { id: "pants_01", name: "Adventurer Pants", level: 1, bonus_hp: 30 },
    boots: { id: "boots_01", name: "Mana Boots", level: 1, bonus_mp: 20 }
  },

  // ğŸ’ HÃ nh trang (Inventory) â€“ gá»“m váº­t pháº©m nháº·t Ä‘Æ°á»£c & chÆ°a xÃ i
  inventory: [
    { id: "hp_potion", name: "HP Potion", type: "consumable", quantity: 5 },
    { id: "mp_potion", name: "MP Potion", type: "consumable", quantity: 3 },
    { id: "iron_ore", name: "Iron Ore", type: "material", quantity: 10 },
    { id: "fire_gem", name: "Fire Gem", type: "upgrade", quantity: 1 }
  ]
}


ğŸ§± Cáº¥u trÃºc thÆ° má»¥c gá»£i Ã½
rpg-api/
â”œâ”€ .env
â”œâ”€ package.json
â”œâ”€ server.js
â”œâ”€ src/
â”‚  â”œâ”€ db.js
â”‚  â”œâ”€ models/
â”‚  â”‚   â””â”€ userModel.js
â”‚  â”œâ”€ routes/
â”‚  â”‚   â”œâ”€ authRoutes.js
â”‚  â”‚   â””â”€ playerRoutes.js
â”‚  â””â”€ utils/
â”‚      â””â”€ hash.js

ğŸ“¦ 1. package.json
{
  "name": "rpg-api",
  "version": "1.0.0",
  "description": "Fastify API for RPG Online game",
  "main": "server.js",
  "type": "module",
  "scripts": {
    "start": "node server.js",
    "dev": "nodemon server.js"
  },
  "dependencies": {
    "dotenv": "^16.4.5",
    "fastify": "^4.26.2",
    "fastify-cors": "^8.4.0",
    "jsonwebtoken": "^9.0.2",
    "mongoose": "^8.6.1",
    "bcryptjs": "^2.4.3"
  },
  "devDependencies": {
    "nodemon": "^3.1.4"
  }
}

ğŸ” 2. .env

(Render sáº½ tá»± Ä‘á»c file nÃ y, khÃ´ng push public nhÃ©)


âš™ï¸ 3. server.js
import Fastify from "fastify";
import cors from "fastify-cors";
import dotenv from "dotenv";
import { connectDB } from "./src/db.js";
import authRoutes from "./src/routes/authRoutes.js";

dotenv.config();
const fastify = Fastify({ logger: true });

// Middleware
fastify.register(cors, { origin: "*" });

// Routes
fastify.register(authRoutes, { prefix: "/auth" });

// Start server
const start = async () => {
  try {
    await connectDB();
    await fastify.listen({ port: process.env.PORT, host: "0.0.0.0" });
    console.log("ğŸš€ Server running on port", process.env.PORT);
  } catch (err) {
    fastify.log.error(err);
    process.exit(1);
  }
};

start();

ğŸ—„ï¸ 4. src/db.js
import mongoose from "mongoose";
import dotenv from "dotenv";
dotenv.config();

export const connectDB = async () => {
  try {
    await mongoose.connect(process.env.MONGO_URI);
    console.log("âœ… MongoDB Connected");
  } catch (err) {
    console.error("âŒ MongoDB connection error:", err);
    process.exit(1);
  }
};

ğŸ‘¤ 5. src/models/userModel.js
import mongoose from "mongoose";

const userSchema = new mongoose.Schema({
  username: { type: String, unique: true, required: true },
  password_hash: { type: String, required: true },
  email: { type: String, required: true },
  created_at: { type: Date, default: Date.now },
  last_login: { type: Date },

  // nhÃ¢n váº­t â€” Ä‘á»ƒ trá»‘ng khi Ä‘Äƒng kÃ½
  character: { type: Object, default: {} },
  equipment: { type: Object, default: {} },
  inventory: { type: Array, default: [] }
});

export const User = mongoose.model("User", userSchema);

ğŸ”‘ 6. src/utils/hash.js
import bcrypt from "bcryptjs";

export const hashPassword = async (plain) => {
  const salt = await bcrypt.genSalt(10);
  return await bcrypt.hash(plain, salt);
};

export const comparePassword = async (plain, hashed) => {
  return await bcrypt.compare(plain, hashed);
};

ğŸ› ï¸ 7. src/routes/authRoutes.js
import { User } from "../models/userModel.js";
import { hashPassword, comparePassword } from "../utils/hash.js";
import jwt from "jsonwebtoken";

export default async function authRoutes(fastify, opts) {
  // ÄÄƒng kÃ½
  fastify.post("/register", async (req, reply) => {
    const { username, password, email } = req.body;
    try {
      const exists = await User.findOne({ username });
      if (exists) return reply.code(400).send({ error: "Username Ä‘Ã£ tá»“n táº¡i" });

      const password_hash = await hashPassword(password);
      const user = await User.create({ username, password_hash, email });
      reply.send({ message: "ÄÄƒng kÃ½ thÃ nh cÃ´ng", userId: user._id });
    } catch (err) {
      console.error(err);
      reply.code(500).send({ error: "Server error" });
    }
  });

  // ÄÄƒng nháº­p
  fastify.post("/login", async (req, reply) => {
    const { username, password } = req.body;
    try {
      const user = await User.findOne({ username });
      if (!user) return reply.code(400).send({ error: "Sai tÃ i khoáº£n" });

      const match = await comparePassword(password, user.password_hash);
      if (!match) return reply.code(400).send({ error: "Sai máº­t kháº©u" });

      user.last_login = new Date();
      await user.save();

      const token = jwt.sign({ id: user._id }, process.env.JWT_SECRET, {
        expiresIn: "7d"
      });

      reply.send({ message: "ÄÄƒng nháº­p thÃ nh cÃ´ng", token });
    } catch (err) {
      console.error(err);
      reply.code(500).send({ error: "Server error" });
    }
  });
}

âœ… Khi deploy lÃªn Render

Push code lÃªn GitHub.

VÃ o Render â†’ â€œNew Web Serviceâ€ â†’ chá»n repo nÃ y.

Render sáº½ Ä‘á»c .env cá»§a báº¡n (báº¡n cÃ³ thá»ƒ táº¡o thá»§ cÃ´ng trong Render Dashboard).

Cá»•ng cháº¡y: 8080

ğŸ§© Sau nÃ y Unity cÃ³ thá»ƒ request:
ğŸ”¹ ÄÄƒng kÃ½

POST https://rpg-api.onrender.com/auth/register

{ "username": "manh72", "password": "123456", "email": "manh@example.com" }

ğŸ”¹ ÄÄƒng nháº­p

POST https://rpg-api.onrender.com/auth/login

{ "username": "manh72", "password": "123456" }


Tráº£ vá» token â†’ dÃ¹ng trong header:

Authorization: Bearer <token>


Báº¡n cÃ³ muá»‘n mÃ¬nh thÃªm luÃ´n route /player/init
â†’ Ä‘á»ƒ khi ngÆ°á»i chÆ¡i Ä‘Äƒng kÃ½ xong, server tá»± táº¡o character rá»—ng (level=1, hp=100, gold=0)?
CÃ¡i Ä‘Ã³ giÃºp Unity Ä‘á»¡ pháº£i gá»­i tá»«ng bÆ°á»›c.